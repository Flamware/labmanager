<!DOCTYPE html>
<html th:lang="${#locale}" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/general :: allBaseLibs" />
<th:block th:replace="fragments/form :: formLibs" />
<th:block th:replace="fragments/buttons :: ajaxButtons" />
<th:block th:replace="fragments/buttons :: waitButtons" />
<th:block th:replace="fragments/buttons :: interactiveDeletionProcess" />

<form id="form">
	<button id="btAdd" class="btn btn-warning mt-4 pr-4 pl-4"
		th:if="${changeEnabled}" th:utext="#{html.AddMembership}"></button>
	<th:block th:each="membership : ${sortedMemberships}">
		<div th:class="${'form-super-group ' + (membership.former ? 'form-super-group-finished' : ((membership.future ? 'form-super-group-future' : 'form-super-group-active')))}">
			<div class="form-group">
				<label th:for="${'organization_' + membership.id}"
					class="col-form-label required" th:utext="#{html.Organization}"></label>
				<select
					class="form-control selectOrganization list-group-item list-group-item-action"
					th:id="${'organization_' + membership.id}" style="width: 100%">
					<option th:each="organization : ${organizations}"
						th:selected="${membership != null && membership.researchOrganization.id == organization.id}"
						th:value="${organization.id}"
						th:utext="${organization.acronymOrName}"></option>
				</select>
			</div>
			<div class="form-group">
				<label th:for="${'status_' + membership.id}"
					class="col-form-label required" th:utext="#{html.Status}"></label>
				<select
					class="form-control selectStatus list-group-item list-group-item-action"
					th:id="${'status_' + membership.id}" style="width: 100%">
					<option
						th:each="status : ${T(fr.ciadlab.labmanager.entities.member.MemberStatus).values}"
						th:selected="${membership != null && membership.memberStatus == status}"
						th:value="${status.name}" th:utext="${status.getLabel(locale)}"></option>
				</select>
			</div>
			<div class="form-group">
				<label th:for="${'memberSinceWhen_' + membership.id}"
					class="col-form-label" th:utext="#{html.MemberSince}"></label>
				<input class="form-control" type="date"
					th:value="${membership.memberSinceWhen == null ? '' : membership.memberSinceWhen.toString}"
					th:id="${'memberSinceWhen_' + membership.id}"></input>
			</div>
			<div class="form-group">
				<label th:for="${'memberToWhen_' + membership.id}"
					class="col-form-label" th:utext="#{html.MemberTo}"></label> <input
					class="form-control" type="date"
					th:value="${membership.memberToWhen == null ? '' : membership.memberToWhen.toString}"
					th:id="${'memberToWhen_' + membership.id}"></input>
			</div>
			<div class="form-group">
				<label th:for="${'cnuSection_' + membership.id}"
					class="col-form-label" th:utext="#{html.CnuSection}"></label> <select
					class="form-control selectCnu list-group-item list-group-item-action"
					th:id="${'cnuSection_' + membership.id}" style="width: 100%">
					<option value="0" th:utext="#{html.NotSpecified}"></option>
					<option
						th:each="cnuSection : ${T(fr.ciadlab.labmanager.utils.cnu.CnuSection).values}"
						th:selected="${membership != null && membership.cnuSection == cnuSection}"
						th:value="${cnuSection.number}"
						th:utext="${cnuSection.number + ' - ' + cnuSection.getLabel(locale)}"></option>
				</select>
			</div>
			<div class="form-group">
				<label th:for="${'conrsSection_' + membership.id}"
					class="col-form-label" th:utext="#{html.ConrsSection}"></label> <select
					class="form-control selectConrs list-group-item list-group-item-action"
					th:id="${'conrsSection_' + membership.id}" style="width: 100%">
					<option value="0" th:utext="#{html.NotSpecified}"></option>
					<option
						th:each="conrsSection : ${T(fr.ciadlab.labmanager.utils.conrs.ConrsSection).values}"
						th:selected="${membership != null && membership.conrsSection == conrsSection}"
						th:value="${conrsSection.number}"
						th:utext="${conrsSection.number + ' - ' + conrsSection.getLabel(locale)}"></option>
				</select>
			</div>
			<div class="form-group">
				<label th:for="${'frenchBap_' + membership.id}"
					class="col-form-label" th:utext="#{html.FrenchBap}"></label> <select
					class="form-control selectFrenchBap list-group-item list-group-item-action"
					th:id="${'frenchBap_' + membership.id}" style="width: 100%">
					<option value="" th:utext="#{html.NotSpecified}"></option>
					<option
						th:each="frenchBap : ${T(fr.ciadlab.labmanager.utils.bap.FrenchBap).values}"
						th:selected="${membership != null && membership.frenchBap == frenchBap}"
						th:value="${frenchBap.shortName}"
						th:utext="${frenchBap.shortName + ' - ' + frenchBap.getLabel(locale)}"></option>
				</select>
			</div>
			<button th:id="${'btSave_' + membership.id}"
				class="btn btn-primary mt-4 pr-4 pl-4" th:if="${changeEnabled}"
				th:utext="#{html.Submit}"></button>
			<button th:id="${'_btDeleteButton_' + membership.id}" type="button"
				class="btn btn-danger mt-4 pr-4 pl-4" th:if="${changeEnabled}"
				th:utext="#{html.DeleteMembership}"></button>
		</div>
	</th:block>
</form>
<script th:inline="javascript">
var nextAvailableIdForMembership = parseInt("[(${minMembershipId})]");

function addSavingButtonCallback(membershipId, isNewMembership) {
	addWaitButtonCallback(
			$('#btSave_' + membershipId),
			"[(#{html.Submit})]",
			"[(#{html.Success})]",
			"[(${savingUrl})]",
			"[(#{html.MembershipSavingError})]",
			null,
			(formData, param) => {
				formData.append("person", parseInt("[(${person.id})]"));
				if (!isNewMembership) {
					formData.append("membership", membershipId);
				}
				formData.append("organization", $('#organization_' + membershipId + ' option:selected').attr('value'));
				formData.append("status", $('#status_' + membershipId + ' option:selected').attr('value'));
				formData.append("memberSinceWhen", $('#memberSinceWhen_' + membershipId).val());
				formData.append("memberToWhen", $('#memberToWhen_' + membershipId).val());
				formData.append("cnuSection", $('#cnuSection_' + membershipId + ' option:selected').attr('value'));
				formData.append("conrsSection", $('#conrsSection_' + membershipId + ' option:selected').attr('value'));
				formData.append("frenchBap", $('#frenchBap_' + membershipId + ' option:selected').attr('value'));
			},
			() => {
				Swal.fire(
						  "[(#{html.Success})]",
						  "[(#{html.MembershipSavingSuccess})]",
						  'success'
						).then(result => {
							location.reload();
						});
			});
}
function getOrganizationName(id) {
	return $('organization_' + id + " option:selected").text();
}
/*[# th:if="${changeEnabled}"]*/
function createPositionBlock() {
	var mid = nextAvailableIdForMembership;
	nextAvailableIdForMembership++;

	var $div0 = $('<div></div>').attr('class', 'form-super-group form-super-group-new');
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group required');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'organization_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.Organization})]");
		$groupDiv.append($label);
		var $select = $('<select></select>').attr('class', 'form-control selectOrganization list-group-item list-group-item-action');
		$select = $select.attr('id', 'organization_' + mid).attr('style', 'width: 100%');
		var $option;
	    /*[# th:each="organization : ${organizations}"]*/
	    $option = $('<option></option>').attr('value', "[(${organization.id})]").text('[(${organization.acronymOrName})]');
		    /*[# th:if="${preferredOrganization != null && organization.id == preferredOrganization.id}"]*/
	    $option = $option.attr('selected', 'true');
	    	/*[/]*/
	    $select.append($option);
    	/*[/]*/
		$groupDiv.append($select);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'status_' + mid);
		$label = $label.attr('class', 'col-form-label required').text("[(#{html.Status})]");
		$groupDiv.append($label);
		var $select = $('<select></select>').attr('class', 'form-control selectStatus list-group-item list-group-item-action');
		$select = $select.attr('id', 'status_' + mid).attr('style', 'width: 100%');
		var $option;
	    /*[# th:each="status : ${T(fr.ciadlab.labmanager.entities.member.MemberStatus).values}"]*/
	    $option = $('<option></option>').attr('value', "[(${status.name})]").text('[(${status.getLabel(locale)})]');
		    /*[# th:if="${preferredStatus != null && status == preferredStatus}"]*/
	    $option = $option.attr('selected', 'true');
	    	/*[/]*/
	    $select.append($option);
    	/*[/]*/
		$groupDiv.append($select);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'memberSinceWhen_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.MemberSince})]");
		$groupDiv.append($label);
		var $input = $('<input></input>').attr('class', 'form-control').attr('type', 'date');
		$input = $input.attr('id', 'memberSinceWhen_' + mid);
		var now = new Date().toISOString().split('T')[0];
		$input.val(now);
		$groupDiv.append($input);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'memberToWhen_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.MemberTo})]");
		$groupDiv.append($label);
		var $input = $('<input></input>').attr('class', 'form-control').attr('type', 'date');
		$input = $input.attr('id', 'memberToWhen_' + mid);
		$groupDiv.append($input);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'cnuSection_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.CnuSection})]");
		$groupDiv.append($label);
		var $select = $('<select></select>').attr('class', 'form-control selectCnu list-group-item list-group-item-action');
		$select = $select.attr('id', 'cnuSection_' + mid).attr('style', 'width: 100%');
		var $option = $('<option></option>').attr('value', '0').text('[(#{html.NotSpecified})]');
	    /*[# th:if="${preferredCnuSection == null}"]*/
	    $option = $option.attr('selected', 'true');
    	/*[/]*/
	    $select.append($option);
	    /*[# th:each="cnuSection : ${T(fr.ciadlab.labmanager.utils.cnu.CnuSection).values}"]*/
	    $option = $('<option></option>').attr('value', "[(${cnuSection.number})]").text("[(${cnuSection.number + ' - ' + cnuSection.getLabel(locale)})]");
		    /*[# th:if="${preferredCnuSection != null && cnuSection == preferredCnuSection}"]*/
	    $option = $option.attr('selected', 'true');
	    	/*[/]*/
	    $select.append($option);
    	/*[/]*/
		$groupDiv.append($select);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'conrsSection_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.ConrsSection})]");
		$groupDiv.append($label);
		var $select = $('<select></select>').attr('class', 'form-control selectConrs list-group-item list-group-item-action');
		$select = $select.attr('id', 'conrsSection_' + mid).attr('style', 'width: 100%');
		var $option = $('<option></option>').attr('value', '0').text('[(#{html.NotSpecified})]');
	    /*[# th:if="${preferredConrsSection == null}"]*/
	    $option = $option.attr('selected', 'true');
    	/*[/]*/
	    $select.append($option);
	    /*[# th:each="conrsSection : ${T(fr.ciadlab.labmanager.utils.conrs.ConrsSection).values}"]*/
	    $option = $('<option></option>').attr('value', "[(${conrsSection.number})]").text("[(${conrsSection.number + ' - ' + conrsSection.getLabel(locale)})]");
		    /*[# th:if="${preferredConrsSection != null && conrsSection == preferredConrsSection}"]*/
	    $option = $option.attr('selected', 'true');
	    	/*[/]*/
	    $select.append($option);
    	/*[/]*/
		$groupDiv.append($select);
	}
	{
		var $groupDiv = $('<div></div>').attr('class', 'form-group');
		$div0.append($groupDiv);
		var $label = $('<label></label>').attr('for', 'frenchBap_' + mid);
		$label = $label.attr('class', 'col-form-label').text("[(#{html.FrenchBap})]");
		$groupDiv.append($label);
		var $select = $('<select></select>').attr('class', 'form-control selectFrenchBap list-group-item list-group-item-action');
		$select = $select.attr('id', 'frenchBap_' + mid).attr('style', 'width: 100%');
		var $option = $('<option></option>').attr('value', '').text('[(#{html.NotSpecified})]');
	    /*[# th:if="${preferredFrenchBap == null}"]*/
	    $option = $option.attr('selected', 'true');
    	/*[/]*/
	    $select.append($option);
	    /*[# th:each="frenchBap : ${T(fr.ciadlab.labmanager.utils.bap.FrenchBap).values}"]*/
	    $option = $('<option></option>').attr('value', "[(${frenchBap.shortName})]").text("[(${frenchBap.shortName + ' - ' + frenchBap.getLabel(locale)})]");
		    /*[# th:if="${preferredFrenchBap != null && frenchBap == preferredFrenchBap}"]*/
	    $option = $option.attr('selected', 'true');
	    	/*[/]*/
	    $select.append($option);
    	/*[/]*/
		$groupDiv.append($select);
	}
	{
		var $bt1 = $('<button></button>').attr('id', 'btSave_' + mid).attr('type', 'button');
		$bt1 = $bt1.attr('class', 'btn btn-primary mt-4 pr-4 pl-4').text("[(#{html.Submit})]");
		$div0.append($bt1);
	}

	$div0.insertAfter('#btAdd');

	addSavingButtonCallback(mid, true);
}
/*[/]*/


$(document).ready(function () {
    /*[# th:if="${changeEnabled}"]*/
	$('#btAdd').on('click', () => {
		$('#btAdd').prop("disabled", true);
		createPositionBlock();
	});

	    /*[# th:each="membership : ${sortedMemberships}"]*/
    addSavingButtonCallback("[(${membership.id})]", false);

    addDeletionButtonCallback0(
    		"[(${membership.id})]",
    		"[(#{html.DeleteMembership})]",
    		"[(#{html.AreYouSureToDeleteMembership})]",
    		"[(${deletionUrl + '?id=' + membership.id})]",
    		"[(#{html.MembershipDeleted})]",
    		"[(#{html.CannotDeleteMembership})]",
    		() => { return getOrganizationName("[(${membership.id})]"); },
    		function (e) {
    			location.reload();
    		} );
    	/*[/]*/
    /*[/]*/
});
</script>
</html>