<!DOCTYPE html>
<html th:lang="${#locale}" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/general :: allBaseLibs"/>
<th:block th:replace="fragments/libs :: bootstrap-datatable"/>
<th:block th:replace="fragments/table :: adminTableDefinition(${changeEnabled})"/>
<th:block th:replace="fragments/buttons :: ajaxButtons"/>
<th:block th:replace="fragments/buttons :: conditionButtons"/>

<p th:utext="#{html.DuplicatePersonIntro}"></p>

<table th:replace="fragments/table :: adminTable(~{::thead}, ~{::tbody})">
    <thead>
        <th th:text="#{html.Names}"></th>
        <th th:text="#{html.Publications}"></th>
        <th th:text="#{html.Organizations}"></th>
        <th th:text="#{html.Actions}"></th>
    </thead>
    <tbody>
    	<tr th:each="duplicates, iMatchingPersons : ${matchingPersons}" th:id="${'duplicateGroup_' + iMatchingPersons.index}">
            <td>
		    	<th:block th:each="candidate, iDuplicates : ${duplicates}">
                    <th:block th:unless="${iDuplicates.first}"
                              th:utext="'<br/>'"></th:block>
                    <th:block th:utext="${candidate.fullName}"></th:block>
                </th:block>
			</td>
            <td>
		    	<th:block th:each="candidate, iDuplicates : ${duplicates}">
                    <th:block th:unless="${iDuplicates.first}"
                              th:utext="'<br/>'"></th:block>
                    <th:block th:utext="${candidate.getAuthorships().size()}"></th:block>
                </th:block>
			</td>
            <td>
		    	<th:block th:each="candidate, iDuplicates : ${duplicates}">
                    <th:block th:unless="${iDuplicates.first}"
                              th:utext="'<br/>'"></th:block>
                    <th:block th:utext="${candidate.getActiveMemberships().size()}"></th:block>
                </th:block>
			</td>
			<td>
		    	<th:block th:if="${changeEnabled}" th:each="candidate, iDuplicates : ${duplicates}">
                    <th:block th:unless="${iDuplicates.first}"
                              th:utext="'<br/>'"></th:block>
					<span th:if="${candidate.getActiveMemberships().isEmpty() && candidate.getAuthorships().isEmpty()}"
					   th:id="${'_btDeleteButton_' + iMatchingPersons.index + '_' + candidate.id}"
					   class="fa fa-trash-o"
					   style="font-size:larger;margin-right:5px;cursor:pointer"
					   th:title="#{html.DeletePerson1(${candidate.fullName})}"></span>
					<span th:unless="${candidate.getActiveMemberships().isEmpty() && candidate.getAuthorships().isEmpty()}"
					   class="fa fa-lock"
					   style="font-size:larger;margin-right:5px;cursor:not-allowed"></span>
					<span th:id="${'btMergeAll_' + iMatchingPersons.index + '_' + candidate.id}"
					   class="fa fa-angle-double-right"
					   style="font-size:larger;margin-right:5px;cursor:pointer"
					   th:title="#{html.DuplicatePersonMergeAll(${candidate.fullName})}"></span>
					<span th:id="${'btMergePart_' + iMatchingPersons.index + '_' + candidate.id}"
					   class="fa fa-angle-right"
					   style="font-size:larger;cursor:pointer"
					   th:title="#{html.DuplicatePersonMergePart(${candidate.fullName})}"></span>
		    	</th:block>
            </td>
    	</tr>
    </tbody>
</table>
<script th:inline="javascript">
function addMergePartButtonCallback( bt, bxTitle, bxMessage, mergeUrl, successMsg, failureMsg, elementName, successCallback ) {
	var htmlContent = bxMessage;
	$.each(mergeUrl.sources, (idx, item) => {
		htmlContent = htmlContent + "<br/><input id='checkbox_partmerge_" + item.id + "' value='"
			+ item.id + "' type='checkbox' checked>" + item.label + "</input>";
	});
    bt.on('click', function(e) {
    	Swal.fire( {
   		  title: bxTitle,
   		  text: bxMessage,
   		  icon: 'question',
   		  html: htmlContent,
   		  preConfirm: () => {
			var selection = [];
			$.each(mergeUrl.sources, (idx, item) => {
				var $component = $('#checkbox_partmerge_' + item.id);
				if ($component.is(':checked')) {
					selection.push($component.prop('value'));
				}
			});
			return selection;
   		  },
   		  showCancelButton: true,
   		  confirmButtonColor: '#d33',
   		  cancelButtonColor: '#99cc00',
   		  confirmButtonText: "[(#{html.YesMergeThem})]"
   		} ).then(result => {
			if (result.isConfirmed) {
				mergeUrl.sources = result.value;
				runMergeAction(mergeUrl, successMsg, successCallback, failureMsg, elementName);
			}
   		} );
    } );
}

$(document).ready(() => {
	adminTableDefinitionWithColCount(3, null, true, '60px');
    /*[# th:if="${changeEnabled}" th:each="duplicates, iMatchingPersons : ${matchingPersons}"]*/
	    /*[# th:each="candidate : ${duplicates}"]*/
			/*[# th:if="${candidate.getActiveMemberships().isEmpty() && candidate.getAuthorships().isEmpty()}"]*/
	addDeletionButtonCallback(
    		"[(${iMatchingPersons.index + '_' + candidate.id})]",
			"[(#{html.DeletePerson1(${candidate.fullName})})]",
			"[(#{html.AreYouSureToDelete(${candidate.fullName})})]",
			"[(@{/deletePerson(person=${candidate.id})})]",
			"[(#{html.PersonDeleted})]",
			"[(#{html.CannotDeletePerson})]",
			"[(${candidate.fullName})]",
    		function (e) {
    			location.reload();
    		} );
		    /*[/]*/

	addConditionButtonCallback(
			$("[(${'#btMergeAll_' + iMatchingPersons.index + '_' + candidate.id})]"),
			"[(#{html.DuplicatePersonMergeAll(${candidate.fullName})})]",
			"[(#{html.AreYouSureToMergeAll(${candidate.fullName})})]",
			"[(@{/mergePersons})]",
			"[(#{html.CannotMergePersons(${candidate.fullName})})]",
			(formData, param) => {
				var target = "[(${candidate.id})]";
				var sources = [
				    /*[# th:each="otherCandidate : ${duplicates}" th:if="${otherCandidate.id != candidate.id}"]*/
				    "[(${otherCandidate.id})]",
				    /*[/]*/
				];
				formData.append("target", target);
				formData.append("sources", sources);
			},
			() => {
				Swal.fire(
						  "[(#{html.Merged})]",
						  "[(#{html.PersonsMerged})]",
						  'success'
						).then(result => {
	    					location.reload();
						});
			},
			null);
	{
		var sources = [
		    /*[# th:each="otherCandidate : ${duplicates}" th:if="${otherCandidate.id != candidate.id}"]*/
		    { id: "[(${otherCandidate.id})]", label: "[(${otherCandidate.fullName})]" },
		    /*[/]*/
		];
		var htmlContent = "[(#{html.AreYouSureToMergePart(${candidate.fullName})})]";
		$.each(sources, (idx, item) => {
			htmlContent = htmlContent + "<br/><input id='__dialog_checkbox_partmerge_" + item.id + "' type='checkbox' checked>" + item.label + "</input>";
		});
		addConditionButtonCallbackHtml(
				$("[(${'#btMergePart_' + iMatchingPersons.index + '_' + candidate.id})]"),
				"[(#{html.DuplicatePersonMergePart(${candidate.fullName})})]",
				htmlContent,
				() => {
					var selection = [];
					var sources = [
					    /*[# th:each="otherCandidate : ${duplicates}" th:if="${otherCandidate.id != candidate.id}"]*/
					    "[(${otherCandidate.id})]",
					    /*[/]*/
					];
					$.each(sources, (idx, item) => {
						var $component = $('#__dialog_checkbox_partmerge_' + item);
						if ($component.is(':checked')) {
							selection.push(item);
						}
					});
					return selection;
				},
				"[(@{/mergePersons})]",
				"[(#{html.CannotMergePersons(${candidate.fullName})})]",
				(formData, param) => {
					var target = "[(${candidate.id})]";
					formData.append("target", target);
					formData.append("sources", param);
				},
				() => {
					Swal.fire(
							  "[(#{html.Merged})]",
							  "[(#{html.PersonsMerged})]",
							  'success'
							).then(result => {
		    					location.reload();
							});
				},
				null);
	}	    
		/*[/]*/
    /*[/]*/
});
</script>
</html>