<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/general :: allBaseLibs" />
<th:block th:replace="fragments/form :: formLibs" />
<th:block th:replace="fragments/formfileinput :: all" />
<th:block th:replace="fragments/formdynlist :: all" />

<th:block th:if="${project != null}">
	<th:block th:replace="fragments/nav :: projectListBar*(#{html.EditProject1(${project.acronymOrScientificTitle})})"/>
</th:block>
<th:block th:if="${project == null}">
	<th:block th:replace="fragments/nav :: projectListBar*(#{html.AddProject})"/>
</th:block>

<form th:replace="fragments/form :: entityForm(project, ${project == null ? '' : project.id}, ${formActionUrl}, ${formRedirectUrl}, #{html.ProjectSavingError}, ~{::.form-group})">
	<div class="form-group" th:replace="fragments/form :: textInput*(acronym, #{html.Acronym}, #{html.PlaceHolderProjectAcronym}, ${project != null ? project.acronym : ''})"></div>
	<div class="form-group" th:replace="fragments/form :: textInput*(scientificTitle, #{html.ScientificTitle}, #{html.PlaceHolderProjectScientificTitle}, ${project != null ? project.scientificTitle : ''})"></div>
	<div class="form-group" th:replace="fragments/form :: dateInput*(startDate, #{html.StartDate}, ${formattedStartDate})"></div>
	<div class="form-group" th:replace="fragments/form :: textInput*(duration, #{html.Duration}, #{html.PlaceHolderMonthDuration}, ${project != null ? project.duration : '0'})"></div>
	<div class="form-group" th:replace="fragments/form :: textAreaInput(description, #{html.Description}, #{html.PlaceHolderProjectDescription}, ${project != null ? project.description : ''})"></div>
	<div class="form-group" th:replace="fragments/form :: textInput*(globalBudget, #{html.ProjectGlobalBudget}, #{html.PlaceHolderProjectGlobalBudget}, ${project != null ? project.globalBudget : '0'})"></div>
	<div class="form-group" th:replace="fragments/formdynlist :: dynamicDataList*(localOrganizationBudgets, #{html.ProjectLocalOrganizationBudget}, #{html.AddProjectBudget})"></div>
	<div class="form-group" th:replace="fragments/form :: checkInput(openSource, #{html.OpenSource}, #{html.OpenSource}, ${project != null ? project.openSource : false})"></div>
	<div class="form-group" th:replace="fragments/form :: checkInput(confidential, #{html.ProjectConfidential}, #{html.ProjectConfidential}, ${project != null ? project.confidential : false})"></div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(status, #{html.ProjectStatus}, ~{::option#option-status})">
		<option id="option-status"
		        th:each="status : ${sortedStatus}"
		        th:selected="${project != null && project.status == status}"
		        th:value="${status.name}"
		        th:utext="${status.getLabel()}"></option>
	</div>
	<div class="form-group" th:replace="fragments/formfileinput :: fileUploadImage(pathToLogo, #{html.ProjectLogo})"></div>
	<div class="form-group" th:replace="fragments/form :: textInput(projectURL, #{html.ProjectURL}, #{html.PlaceHolderURL}, ${project != null ? project.projectURL : ''})"></div>
	<div class="form-group" th:replace="fragments/form :: comboInput(webPageNaming, #{html.ProjectWebPageNaming}, ~{::option#option-webpagenaming})">
		<option id="option-webpagenaming"
		        th:each="naming : ${T(fr.ciadlab.labmanager.entities.project.ProjectWebPageNaming).values}"
		        th:selected="${(project == null && naming == defaultNaming) || (project != null && project.webPageNaming == naming)}"
		        th:value="${naming.name}"
		        th:utext="${naming.getLabel()}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(activityType, #{html.ProjectActivityType}, ~{::option#option-activitytype})">
		<option id="option-activitytype"
		        th:each="type : ${sortedActivityTypes}"
		        th:selected="${project != null && project.activityType == type}"
		        th:value="${type.name}"
		        th:utext="${type.getLabel()}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(trl, #{html.ProjectTrl}, ~{::option#option-trl})">
		<option id="option-trl"
		        th:each="level : ${sortedTrls}"
		        th:selected="${project != null && project.TRL == level}"
		        th:value="${level.name}"
		        th:utext="${level.name + ' - ' + level.getLabel()}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(coordinator, #{html.ProjectCoordinator}, ~{::option#option-coordinator})">
		<option id="option-coordinator"
		        th:each="coordinator : ${organizations}"
		        th:selected="${project != null && project.coordinator != null && project.coordinator.id == coordinator.id}"
		        th:value="${coordinator.id}"
		        th:utext="${coordinator.acronym + ' - ' + coordinator.name}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(localOrganization, #{html.ProjectLocalOrganization}, ~{::option#option-localOrganization})">
		<option id="option-localOrganization"
		        th:each="localOrganization : ${organizations}"
		        th:selected="${(project == null && defaultLocalOrganization != null && localOrganization.id == defaultLocalOrganization.id) || (project != null && project.localOrganization != null && project.localOrganization.id == localOrganization.id)}"
		        th:value="${localOrganization.id}"
		        th:utext="${localOrganization.acronym + ' - ' + localOrganization.name}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput(superOrganization, #{html.ProjectSuperOrganization}, ~{::option#option-superOrganization})">
		<option id="option-superOrganization"
		        th:each="superOrganization : ${organizations}"
		        th:selected="${(project == null && defaultSuperOrganization != null && superOrganization.id == defaultSuperOrganization.id) || (project != null && project.superOrganization != null && project.superOrganization.id == superOrganization.id)}"
		        th:value="${superOrganization.id}"
		        th:utext="${superOrganization.acronym + ' - ' + superOrganization.name}"></option>
	</div>
	<div class="form-group" th:replace="fragments/form :: comboInput*(learOrganization, #{html.ProjectLearOrganization}, ~{::option#option-learOrganization})">
		<option id="option-learOrganization"
		        th:each="learOrganization : ${organizations}"
		        th:selected="${(project == null && defaultLearOrganization != null && learOrganization.id == defaultLearOrganization.id) || (project != null && project.learOrganization != null && project.learOrganization.id == learOrganization.id)}"
		        th:value="${learOrganization.id}"
		        th:utext="${learOrganization.acronym + ' - ' + learOrganization.name}"></option>
	</div>
	<div class="form-group" th:replace="fragments/formdynlist :: dynamicDataList(otherPartners, #{html.ProjectOtherPartners}, #{html.AddProjectPartner})"></div>
	<div class="form-group" th:replace="fragments/formdynlist :: dynamicDataList(participants, #{html.ProjectParticipants}, #{html.AddProjectParticipant})"></div>
	<div class="form-group" th:replace="fragments/formfileinput :: fileUploadPdf(pathToScientificRequirements, #{html.ProjectScientificRequirements})"></div>
	<div class="form-group" th:replace="fragments/formfileinput :: fileUploadImages(pathsToImages, #{html.ProjectAssociatedImages})"></div>
	<div class="form-group" th:replace="fragments/formdynlist :: dynamicDataList(videoURLs, #{html.ProjectVideoURLs}, #{html.AddVideoURL})"></div>
	<div class="form-group" th:replace="fragments/formfileinput :: fileUploadPpt(pathToPowerpoint, #{html.ProjectPowerPoint})"></div>
	<div class="form-group" th:replace="fragments/formfileinput :: fileUploadPdf(pathToPressDocument, #{html.ProjectPressDocument})"></div>
	<div class="form-group" th:replace="fragments/form :: checkInput(validated, #{html.ValidatedProject}, #{html.ValidatedProject}, ${project != null ? project.validated : false})"></div>
</form>
<script type="text/javascript" th:inline="javascript">
var ALL_ORGANIZATIONS = {
	/*[# th:each="organization : ${organizations}"]*/
	"[(${organization.id})]": "[(${organization.acronym + ' - ' + organization.name})]",
    /*[/]*/
};
var ALL_PERSONS = {
	/*[# th:each="person : ${persons}"]*/
	"[(${person.id})]": "[(${person.fullNameWithLastNameFirst})]",
    /*[/]*/
};
var ALL_PERSON_OPTIONS =  null;
var ALL_ROLES = {
	/*[# th:each="role : ${T(fr.ciadlab.labmanager.entities.project.Role).values}"]*/
	"[(${role.name})]": "[(${role.getLabel()})]",
    /*[/]*/
};
var ALL_ROLE_OPTIONS =  null;
var ALL_FUNDING_SCHEMES = {
		/*[# th:each="scheme : ${sortedFundingSchemes}"]*/
		"[(${scheme.name})]": "[(${scheme.getLabel()})]",
	    /*[/]*/
	};
var ALL_FUNDING_SCHEME_OPTIONS = null;
$(document).ready(function () {
	
	// Initialize form validation
	
	$('#form:first').validate({
        rules: {
        	acronym: {
                required: true,
        	},
        	scientificTitle: {
                required: true,
                minlength: 5
            },
        	startDate: {
                required: true,
            },
        	duration: {
                required: true,
            },
        	globalBudget: {
                required: true,
            },
        	budget: {
                required: true,
            },
        	projectURL: {
                required: false,
                url: true
            },
        },
    });
	
	// Initialize file upload components
	
	initFileUploadSinglePdf({
		name: 'pathToScientificRequirements',
		basename: "[(${pathToScientificRequirements_basename})]",
		picture: "[(${pathToScientificRequirements_picture})]",
	});
	initFileUploadSingleImage({
		name: 'pathToLogo',
		basename: "[(${pathToLogo_basename})]",
		picture: "[(${pathToLogo_picture})]",
	});
	initFileUploadSinglePpt({
		name: 'pathToPowerpoint',
		basename: "[(${pathToPowerpoint_basename})]",
		picture: "[(${pathToPowerpoint_picture})]",
	});
	initFileUploadSinglePdf({
		name: 'pathToPressDocument',
		basename: "[(${pathToPressDocument_basename})]",
		picture: "[(${pathToPressDocument_picture})]",
	});
	initFileUploadMultiImages({
		name: 'pathsToImages',
		files: [
	        /*[# th:each="image : ${pathsToImages}"]*/
	        {
	        	picture: "[(${image.picture})]",
	        	basename: "[(${image.basename})]",
	        },
		    /*[/]*/
		],
	});
	initDynamicDataList({
		name: 'localOrganizationBudgets',
		columnCount: 3,
		deleteLabel: [[#{html.DeleteProjectBudget}]],
		deleteTitle: [[#{html.Delete}]],
		deleteMessage: [[#{html.AreYouSureToDelete}]],
		data: [
			/*[# th:if="${project != null}"]*//*[# th:each="budget : ${project.budgets}"]*/
	        {
				fundingScheme: "[(${budget.fundingScheme.name})]",
				budget: "[(${budget.budget})]",
				grant: "[(${budget.grant})]",
	        },
		    /*[/]*//*[/]*/
		],
		dataName: (dt) => {
			return dt['fundingScheme'] + ' - ' + dt['budget'];
		},
		rowBuilder: (data, target, index) => {
			if (index == 2) {
				target.append(data['grant']);
			} else if (index == 1) {
				target.append(data['budget'] + " [(#{html.KEURO})]");
			} else {
				target.append(ALL_FUNDING_SCHEMES[data['fundingScheme']]);
			}
		},
		dataConverter: (formData, fieldName, data) => {
			formData.append(fieldName, JSON.stringify(data));
		},
		dataCreator: (doCreateFct) => {
			if (!ALL_FUNDING_SCHEME_OPTIONS) {
				ALL_FUNDING_SCHEME_OPTIONS = '';
				$.each(ALL_FUNDING_SCHEMES, (name, label) => {
					ALL_FUNDING_SCHEME_OPTIONS = ALL_FUNDING_SCHEME_OPTIONS + '<option value="' + name + '">'+ label + '</option>';
				});
			}
			Swal.fire({
				title: [[#{html.AddProjectBudget}]],
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#99cc00',
				confirmButtonText: [[#{html.Add}]],
				grow: 'row',
				html: "[(#{html.FundingScheme0})]<br/>"
					+ '<select id="swal-input1" class="swal2-input">'
					+ ALL_FUNDING_SCHEME_OPTIONS
					+ '</select><br/>'
					+ "[(#{html.ProjectBudget})] ([(#{html.KEURO})])<br/>"
					+ '<input id="swal-input2" class="swal2-input" type="text" placeholder="[(#{html.PlaceHolderProjectBudget})]"/><br/>'
					+ "[(#{html.Grant})]<br/>"
					+ '<input id="swal-input3" class="swal2-input" type="text" placeholder="[(#{html.PlaceHolderGrant})]"/><br/>',
				preConfirm: () => {
					return {
						fundingScheme: document.getElementById("swal-input1").value,
						budget: document.getElementById("swal-input2").value,
						grant: document.getElementById("swal-input3").value,
					};
				},
			}).then(result => {
				if (result.isConfirmed) {
					var value = result.value;
					doCreateFct(value);
				}
			});
		},
	});
	initDynamicDataList({
		name: 'otherPartners',
		deleteLabel: [[#{html.DeleteProjectPartner}]],
		deleteTitle: [[#{html.Delete}]],
		deleteMessage: [[#{html.AreYouSureToDelete}]],
		data: [
	        /*[# th:if="${project != null}"]*//*[# th:each="partner : ${project.otherPartners}"]*/
	        "[(${partner.id})]",
		    /*[/]*//*[/]*/
		],
		dataName: (dt) => {
			return ALL_ORGANIZATIONS[dt];
		},
		rowBuilder: (data, target, index) => {
			target.append(ALL_ORGANIZATIONS[data]);
		},
		dataCreator: (doCreateFct) => {
			Swal.fire({
				title: [[#{html.AddProjectPartner}]],
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#99cc00',
				confirmButtonText: [[#{html.Add}]],
				input: 'select',
				inputOptions: ALL_ORGANIZATIONS,
			}).then(result => {
				if (result.isConfirmed) {
					var value = result.value;
					doCreateFct(value);
				}
			});
		},
	});
	initDynamicDataList({
		name: 'participants',
		columnCount: 2,
		deleteLabel: [[#{html.DeleteProjectParticipant}]],
		deleteTitle: [[#{html.Delete}]],
		deleteMessage: [[#{html.AreYouSureToDelete}]],
		data: [
			/*[# th:if="${project != null}"]*//*[# th:each="participant : ${project.participants}"]*/
	        {
				person: "[(${participant.person.id})]",	        	
				role: "[(${participant.role.name})]",	        	
	        },
		    /*[/]*//*[/]*/
		],
		dataName: (dt) => {
			return ALL_PERSONS[dt['person']];
		},
		rowBuilder: (data, target, index) => {
			if (index == 1) {
				target.append(ALL_ROLES[data['role']]);
			} else {
				target.append(ALL_PERSONS[data['person']]);
			}
		},
		dataConverter: (formData, fieldName, data) => {
			formData.append(fieldName, JSON.stringify(data));
		},
		dataCreator: (doCreateFct) => {
			if (!ALL_PERSON_OPTIONS) {
				ALL_PERSON_OPTIONS = '';
				$.each(ALL_PERSONS, (id, name) => {
					ALL_PERSON_OPTIONS = ALL_PERSON_OPTIONS + '<option value="' + id + '">'+ name + '</option>';
				});
			}
			if (!ALL_ROLE_OPTIONS) {
				ALL_ROLE_OPTIONS = '';
				$.each(ALL_ROLES, (name, label) => {
					ALL_ROLE_OPTIONS = ALL_ROLE_OPTIONS + '<option value="' + name + '">'+ label + '</option>';
				});
			}
			Swal.fire({
				title: [[#{html.AddProjectParticipant}]],
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#99cc00',
				confirmButtonText: [[#{html.Add}]],
				html: "[(#{html.ProjectParticipant})]<br/>"
					+ '<select id="swal-input1" class="swal2-input">'
					+ ALL_PERSON_OPTIONS
					+ '</select><br/>'
					+ "[(#{html.ProjectRole})]<br/>"
					+ '<select id="swal-input2" class="swal2-input">'
				    + ALL_ROLE_OPTIONS
					+ '</select><br/>',
				preConfirm: () => {
					return {
						person: document.getElementById("swal-input1").value,
						role: document.getElementById("swal-input2").value,
					};
				},
			}).then(result => {
				if (result.isConfirmed) {
					var value = result.value;
					doCreateFct(value);
				}
			});
		},
	});
	initDynamicDataList({
		name: 'videoURLs',
		deleteLabel: [[#{html.DeleteVideoURL}]],
		deleteTitle: [[#{html.Delete}]],
		deleteMessage: [[#{html.AreYouSureToDelete}]],
		data: [
			/*[# th:if="${project != null}"]*//*[# th:each="url : ${project.videoURLs}"]*/
	        "[(${url})]",
		    /*[/]*//*[/]*/
		],
		rowBuilder: (data, target, index) => {
			target.append(data);
		},
		dataCreator: (doCreateFct) => {
			Swal.fire({
				title: [[#{html.AddVideoURL}]],
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#99cc00',
				confirmButtonText: [[#{html.Add}]],
				input: 'url',
				inputLabel: [[#{html.VideoURL}]],
				inputPlaceholder: [[#{html.PlaceHolderURL}]],
			}).then(result => {
				if (result.isConfirmed) {
					var value = result.value;
					doCreateFct(value);
				}
			});
		},
	});
});
</script>
</html>